import os
import random
import json
import requests
import time
import re
from datetime import datetime
import pytz
import gspread
import google.generativeai as genai
from google.oauth2.service_account import Credentials

# --- å®šæ•°è¨­å®š ---
SPREADSHEET_NAME = 'ã‚³ã‚¹ãƒ¡æŠ•ç¨¿æ¡ˆãƒªã‚¹ãƒˆ'
SERVICE_ACCOUNT_FILE = 'google_credentials.json'

# --- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®šç¾© ---
# ã‚­ãƒ¼ã¯ã€Œæ™‚:åˆ†ã€ã€å€¤ã¯å®Ÿè¡Œã™ã‚‹ã‚¿ã‚¹ã‚¯ã®ç¨®é¡
WEEKDAY_SCHEDULE = {
    "07:00": "planner", "07:30": "planner", "08:30": "planner",
    "12:05": "planner", "12:30": "planner", "16:00": "planner",
    "17:30": "planner", "19:00": "affiliate", "20:00": "affiliate",
    "21:00": "affiliate", "21:45": "planner", "22:15": "affiliate",
    "23:00": "planner", "23:45": "planner", "00:30": "planner"
}
HOLIDAY_SCHEDULE = {
    "09:30": "planner", "10:30": "planner", "11:30": "affiliate",
    "13:00": "planner", "14:30": "planner", "16:00": "affiliate",
    "17:30": "planner", "19:00": "planner", "20:00": "affiliate",
    "21:00": "affiliate", "21:45": "planner", "22:30": "affiliate",
    "23:15": "planner", "23:50": "affiliate", "00:30": "planner"
}

# --- åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ---
def setup():
    """APIã‚­ãƒ¼ã®èª­ã¿è¾¼ã¿ã¨è¨­å®šã‚’è¡Œã†"""
    try:
        GEMINI_API_KEY = os.getenv('GEMINI_API_KEY2')
        RAKUTEN_APP_ID = os.getenv('RAKUTEN_APP_ID')
        RAKUTEN_AFFILIATE_ID = os.getenv('RAKUTEN_AFFILIATE_ID')

        if not all([GEMINI_API_KEY, RAKUTEN_APP_ID, RAKUTEN_AFFILIATE_ID]):
            print("ğŸ›‘ ã‚¨ãƒ©ãƒ¼: å¿…è¦ãªAPIã‚­ãƒ¼ãŒç’°å¢ƒå¤‰æ•°ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
            return None, None, None

        genai.configure(api_key=GEMINI_API_KEY)
        print("âœ… APIã‚­ãƒ¼ã®èª­ã¿è¾¼ã¿ã«æˆåŠŸã—ã¾ã—ãŸã€‚")
        return GEMINI_API_KEY, RAKUTEN_APP_ID, RAKUTEN_AFFILIATE_ID
    except Exception as e:
        print(f"ğŸ›‘ ã‚¨ãƒ©ãƒ¼: ç’°å¢ƒå¤‰æ•°ã‹ã‚‰APIã‚­ãƒ¼ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼è©³ç´°: {e}")
        return None, None, None

def get_gspread_client():
    """ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ã£ã¦gspreadã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’èªè¨¼ãƒ»å–å¾—ã™ã‚‹"""
    scopes = ['https://www.googleapis.com/auth/spreadsheets', 'https://www.googleapis.com/auth/drive']
    if os.path.exists(SERVICE_ACCOUNT_FILE):
        creds = Credentials.from_service_account_file(SERVICE_ACCOUNT_FILE, scopes=scopes)
        return gspread.authorize(creds)
    else:
        print(f"ğŸ›‘ ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ« '{SERVICE_ACCOUNT_FILE}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
        return None

# ==============================================================================
# ãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼‘ï¼šä¾¡å€¤æä¾›ãƒ„ã‚¤ãƒ¼ãƒˆæ¡ˆï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰å½¢å¼ï¼‰ã‚’ç”Ÿæˆã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ 
# ==============================================================================
def run_content_planner(worksheet):
    print("--- ä¾¡å€¤æä¾›ãƒ„ã‚¤ãƒ¼ãƒˆæ¡ˆã®ç”Ÿæˆã‚’å®Ÿè¡Œã—ã¾ã™ ---")
    # (ã“ã®é–¢æ•°ã®å†…å®¹ã¯å‰å›ã¨åŒã˜ã§ã™)
    theme_prompt = f"ã‚ãªãŸã¯ã€æ—¥æœ¬ã®SNSãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã®å°‚é–€å®¶ã§ã™ã€‚X(Twitter)ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€Œã‚†ã‚ï¼ ãƒ—ãƒãƒ—ãƒ©ã‚³ã‚¹ãƒ¡å¡¾ã€ã®æŠ•ç¨¿ãƒ†ãƒ¼ãƒã‚’ã€ä»Šåº¦ã¯å°‘ã—è©³ã—ã‚ã«è§£èª¬ã§ãã‚‹ã‚ˆã†ãªã‚‚ã®ã‚’5å€‹è€ƒãˆã¦ãã ã•ã„ã€‚\n# ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±\n- ã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼šæ—¥æœ¬ã®10ä»£ã€œ20ä»£ã®å¥³æ€§\n- ã‚³ãƒ³ã‚»ãƒ—ãƒˆï¼šãƒ—ãƒãƒ—ãƒ©ã‚³ã‚¹ãƒ¡å°‚é–€å®¶ã€Œã‚†ã‚ã€ãŒã€å¡¾ã®å…ˆç”Ÿã®ã‚ˆã†ã«ã‚³ã‚¹ãƒ¡ã®é¸ã³æ–¹ã‚„ãƒ¡ã‚¤ã‚¯è¡“ã‚’æ•™ãˆã‚‹\n- ç›®çš„ï¼šãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã‚’å¢—ã‚„ã™ã“ã¨ã€‚ç‰¹ã«æƒ…å ±ã®ä¾¡å€¤ã‚’é«˜ã‚ã€æŠ•ç¨¿ã®ä¿å­˜æ•°ã‚’å¢—ã‚„ã—ãŸã„\n# è€ƒæ…®ã™ã¹ãç¾åœ¨ã®çŠ¶æ³\n- ç¾åœ¨ã®æ™‚æœŸï¼š{datetime.now(pytz.timezone('Asia/Tokyo')).strftime('%Yå¹´%mæœˆ')}\n- å­£ç¯€çš„ãªæ‚©ã¿ï¼šæ¢…é›¨ã®æ¹¿æ°—ã€æ±—ã«ã‚ˆã‚‹ãƒ¡ã‚¤ã‚¯å´©ã‚Œã€ç´«å¤–ç·šå¯¾ç­–ã€å¤ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã‚«ãƒ©ãƒ¼ãªã©\n# å‡ºåŠ›å½¢å¼\n- 1è¡Œã«1ã¤ã®ãƒ†ãƒ¼ãƒã§ã€ãƒªã‚¹ãƒˆå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚\n- ç•ªå·ã‚„ãƒã‚¤ãƒ•ãƒ³ã¯ä¸è¦ã§ã™ã€‚"
    try:
        model = genai.GenerativeModel('gemini-1.5-flash')
        response = model.generate_content(theme_prompt)
        ideas = [re.sub(r'^\s*[-*ãƒ»]?\s*', '', idea).strip() for idea in response.text.strip().split('\n') if idea.strip()]
        print(f"âœ… ç”Ÿæˆã•ã‚ŒãŸãƒ†ãƒ¼ãƒ: {ideas}")
        for topic in ideas:
            print(f"--- æŠ•ç¨¿æ¡ˆï¼šã€{topic}ã€---")
            post_prompt = f"ã‚ãªãŸã¯ã€Xã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€Œã‚†ã‚ï¼ ãƒ—ãƒãƒ—ãƒ©ã‚³ã‚¹ãƒ¡å¡¾ã€ã®é‹å–¶è€…ã€Œã‚†ã‚ã€ã§ã™ã€‚ãƒ—ãƒãƒ—ãƒ©ã‚³ã‚¹ãƒ¡ã®å°‚é–€å®¶ã¨ã—ã¦ã€10ä»£ã€œ20ä»£ã®ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ã«ãƒ¡ã‚¤ã‚¯ã®æ¥½ã—ã•ã‚„ã‚³ãƒ„ã‚’æ•™ãˆã¦ã„ã¾ã™ã€‚ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’å³å®ˆã—ã¦ã€ã€Œã‚¹ãƒ¬ãƒƒãƒ‰æŠ•ç¨¿ï¼ˆè¤‡æ•°ã®æŠ•ç¨¿ãŒé€£ãªã‚‹å½¢å¼ï¼‰ã€ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚\n# ãƒ«ãƒ¼ãƒ«\n- è¦ªã—ã¿ã‚„ã™ãã€å°‘ã—å…ˆç”Ÿã®ã‚ˆã†ãªé ¼ã‚Œã‚‹å£èª¿ã§æ›¸ãã€‚\n- 2ã€œ3å€‹ã®æŠ•ç¨¿ã§æ§‹æˆã•ã‚Œã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆã™ã‚‹ã€‚\n- ã€1ç•ªç›®ã®æŠ•ç¨¿ã€‘ã¯ã€èª­è€…ã®èˆˆå‘³ã‚’å¼•ãã€Œå•é¡Œæèµ·ã€ã‚„ã€Œçµè«–ã®äºˆå‘Šã€ã§å§‹ã‚ã‚‹ã€‚æŠ•ç¨¿ã®æœ€å¾Œã¯ã€Œç¶šãã¯ãƒªãƒ—æ¬„ã¸ï¼ğŸ‘‡ã€ã®ã‚ˆã†ã«ã€ã‚¹ãƒ¬ãƒƒãƒ‰ãŒç¶šãã“ã¨ã‚’ç¤ºã™è¨€è‘‰ã§ç· ã‚ã‚‹ã€‚\n- ã€2ç•ªç›®ä»¥é™ã®æŠ•ç¨¿ã€‘ã§ã€å…·ä½“çš„ãªæ–¹æ³•ã€å•†å“ã®ç´¹ä»‹ã€è©³ã—ã„è§£èª¬ã‚’è¡Œã†ã€‚çµµæ–‡å­—ã‚„ç®‡æ¡æ›¸ãã‚’ä½¿ã„ã€è¦–è¦šçš„ã«åˆ†ã‹ã‚Šã‚„ã™ãã™ã‚‹ã€‚\n- å„æŠ•ç¨¿ã¯ã€çµµæ–‡å­—ã‚„ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’å«ã‚ã¦ã€å¿…ãšæ—¥æœ¬èª140æ–‡å­—ä»¥å†…ã«å³å¯†ã«ãŠã•ã‚ã‚‹ã“ã¨ã€‚\n- å„æŠ•ç¨¿ã®é–“ã¯ã€å¿…ãšã€Œ---ã€ã¨ã„ã†åŒºåˆ‡ã‚Šæ–‡å­—ã ã‘ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚\n- ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ï¼ˆ#ãƒ—ãƒãƒ—ãƒ©ã‚³ã‚¹ãƒ¡ #ã‚³ã‚¹ãƒ¡å¡¾ ãªã©ï¼‰ã¯ã€ã‚¹ãƒ¬ãƒƒãƒ‰ã®æœ€å¾Œã®æŠ•ç¨¿ã«ã¾ã¨ã‚ã¦3ã¤ç¨‹åº¦å…¥ã‚Œã‚‹ã€‚\n# æŠ•ç¨¿ãƒ†ãƒ¼ãƒ\n{topic}"
            response = model.generate_content(post_prompt)
            threaded_posts = [post.strip() for post in response.text.strip().split('---') if post.strip()]
            jst = pytz.timezone('Asia/Tokyo')
            timestamp = datetime.now(jst).strftime('%Y-%m-%d %H:%M:%S')
            row_to_add = [timestamp, topic] + threaded_posts
            worksheet.append_row(row_to_add)
            print(f"âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã—ã¾ã—ãŸã€‚")
            time.sleep(20) # Gemini APIã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–
    except Exception as e:
        print(f"ğŸ›‘ ã‚¨ãƒ©ãƒ¼: ä¾¡å€¤æä¾›ãƒ„ã‚¤ãƒ¼ãƒˆã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼: {e}")


# ==============================================================================
# ãƒ—ãƒ­ã‚°ãƒ©ãƒ ï¼’ï¼šã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆæŠ•ç¨¿æ¡ˆã‚’ç”Ÿæˆã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ 
# ==============================================================================
def run_affiliate_bot(worksheet, RAKUTEN_APP_ID, RAKUTEN_AFFILIATE_ID):
    print("--- ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆæŠ•ç¨¿æ¡ˆã®ç”Ÿæˆã‚’å®Ÿè¡Œã—ã¾ã™ ---")
    # (ã“ã®é–¢æ•°ã®å†…å®¹ã¯å‰å›ã¨åŒã˜ã§ã™)
    try:
        keyword_prompt = "ã‚ãªãŸã¯ã€æ¥½å¤©å¸‚å ´ã§ã“ã‚Œã‹ã‚‰åŒ–ç²§å“ã‚’æ¢ãã†ã¨ã—ã¦ã„ã‚‹ã€ãƒˆãƒ¬ãƒ³ãƒ‰ã«æ•æ„Ÿãªæ—¥æœ¬ã®10ä»£ã€œ20ä»£ã®å¥³æ€§ã§ã™ã€‚ã€Œãƒ—ãƒãƒ—ãƒ©ã‚³ã‚¹ãƒ¡ã€ã‚„ã€ŒéŸ“å›½ã‚³ã‚¹ãƒ¡ã€ã«é–¢é€£ã™ã‚‹ã€å…·ä½“çš„ã§ãƒ’ãƒƒãƒˆã—ã‚„ã™ã„æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’1ã¤ã ã‘ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚\n# æŒ‡ç¤º:\n- ãƒ–ãƒ©ãƒ³ãƒ‰åã‚„å•†å“ã‚«ãƒ†ã‚´ãƒªåã‚’çµ„ã¿åˆã‚ã›ã‚‹ã®ã‚‚è‰¯ã„æ–¹æ³•ã§ã™ã€‚(ä¾‹: KATE ãƒªãƒƒãƒ—ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼)\n- å›ç­”ã¯ã€ç”Ÿæˆã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æ–‡å­—åˆ—ã ã‘ã«ã—ã¦ãã ã•ã„ã€‚"
        model = genai.GenerativeModel("gemini-1.5-flash")
        response = model.generate_content(keyword_prompt)
        keyword = response.text.strip()
        print(f"âœ… ç”Ÿæˆã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: {keyword}")

        url = "https://app.rakuten.co.jp/services/api/IchibaItem/Search/20220601"
        params = {"applicationId": RAKUTEN_APP_ID, "affiliateId": RAKUTEN_AFFILIATE_ID, "keyword": keyword, "format": "json", "sort": "-reviewCount", "hits": 10}
        response = requests.get(url, params=params)
        response.raise_for_status()
        items = response.json().get("Items", [])

        if not items:
            print("âš ï¸ æ¥½å¤©ã§å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
            return

        formatted_items_string = "\n".join([f"- å•†å“å: {item['Item']['itemName']}, URL: {item['Item']['affiliateUrl']}" for item in items])
        tweet_prompt = f"ã‚ãªãŸã¯äººæ°—ã®ã‚³ã‚¹ãƒ¡ã‚’ç´¹ä»‹ã™ã‚‹ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚µãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®æ¥½å¤©ã®å•†å“ãƒªã‚¹ãƒˆã®ä¸­ã‹ã‚‰ã€10ä»£ã‹ã‚‰20ä»£ã®å¥³æ€§ã«æœ€ã‚‚ãŠã™ã™ã‚ã—ãŸã„ã€Œæœ€å¼·ã®ãƒ—ãƒãƒ—ãƒ©ã‚³ã‚¹ãƒ¡ã€ã‚’1ã¤ã ã‘é¸ã³ã€ãã®å•†å“ã®ç´¹ä»‹æ–‡ã¨ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆURLã‚’JSONå½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ã€‚\n# åˆ¶ç´„æ¡ä»¶:\n- ã€Œä¾¡æ ¼ã€ã«ã¯è§¦ã‚Œãªã„ã§ãã ã•ã„ã€‚\n- ç´¹ä»‹æ–‡ã¯100æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„ã€‚\n- ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã€Œ#PRã€ã€Œ#ãƒ—ãƒãƒ—ãƒ©ã‚³ã‚¹ãƒ¡ã€ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚\n# JSONå½¢å¼:\n{{\n  \"tweet_text\": \"ï¼ˆç´¹ä»‹æ–‡ï¼‰\",\n  \"affiliate_url\": \"ï¼ˆURLï¼‰\"\n}}\n# å•†å“ãƒªã‚¹ãƒˆ:\n{formatted_items_string}"

        response = model.generate_content(tweet_prompt)
        cleaned_response = response.text.strip().replace("```json", "").replace("```", "")
        result = json.loads(cleaned_response)

        short_url_res = requests.get(f"http://tinyurl.com/api-create.php?url={result['affiliate_url']}")
        short_url = short_url_res.text if short_url_res.status_code == 200 else result['affiliate_url']

        full_tweet = f"{result['tweet_text']}\n\nğŸ‘‡å•†å“ã®è©³ç´°ã¯ã“ã¡ã‚‰ã‹ã‚‰ãƒã‚§ãƒƒã‚¯âœ¨\n{short_url}"
        print("--- ç”Ÿæˆã•ã‚ŒãŸæŠ•ç¨¿æ¡ˆ ---")
        print(full_tweet)
        print("----------------------")

        jst = pytz.timezone('Asia/Tokyo')
        timestamp = datetime.now(jst).strftime('%Y-%m-%d %H:%M:%S')
        row_to_add = [timestamp, f"ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆæŠ•ç¨¿: {keyword}", full_tweet]
        worksheet.append_row(row_to_add)
        print("âœ… ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆæŠ•ç¨¿æ¡ˆã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è¨˜éŒ²ã—ã¾ã—ãŸã€‚")
    except Exception as e:
        print(f"ğŸ›‘ ã‚¨ãƒ©ãƒ¼: ã‚¢ãƒ•ã‚£ãƒªã‚¨ã‚¤ãƒˆæŠ•ç¨¿ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼: {e}")


# ==============================================================================
# ãƒ¡ã‚¤ãƒ³ã®å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯
# ==============================================================================
if __name__ == "__main__":
    print("ğŸš€ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã‚’é–‹å§‹ã—ã¾ã™ã€‚")
    GEMINI_API_KEY, RAKUTEN_APP_ID, RAKUTEN_AFFILIATE_ID = setup()

    if not GEMINI_API_KEY:
        raise SystemExit("APIã‚­ãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ãŸãŸã‚ã€å‡¦ç†ã‚’çµ‚äº†ã—ã¾ã™ã€‚")

    # JSTã§ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—
    jst = pytz.timezone('Asia/Tokyo')
    now = datetime.now(jst)
    current_time_str = now.strftime("%H:%M")
    # æ›œæ—¥ã‚’å–å¾— (0=æœˆ, 1=ç«, ... 5=åœŸ, 6=æ—¥)
    weekday = now.weekday()

    print(f"ç¾åœ¨ã®æ—¥æœ¬æ™‚é–“ã¯ {now.strftime('%Y-%m-%d %H:%M:%S')} ({['æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ','æ—¥'][weekday]}æ›œæ—¥) ã§ã™ã€‚")

    # å¹³æ—¥ã‹ä¼‘æ—¥ã‹ã‚’åˆ¤æ–­ (åœŸæ—¥ã‚’ä¼‘æ—¥ã¨ã™ã‚‹)
    if weekday < 5: # 0-4ã¯å¹³æ—¥
        schedule = WEEKDAY_SCHEDULE
        print("æœ¬æ—¥ã¯å¹³æ—¥ã§ã™ã€‚")
    else: # 5,6ã¯ä¼‘æ—¥
        schedule = HOLIDAY_SCHEDULE
        print("æœ¬æ—¥ã¯ä¼‘æ—¥ã§ã™ã€‚")

    # ç¾åœ¨æ™‚åˆ»ãŒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    if current_time_str in schedule:
        task = schedule[current_time_str]
        print(f"â° ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚ŒãŸæ™‚åˆ»ã§ã™ï¼ã‚¿ã‚¹ã‚¯ã€Œ{task}ã€ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚")

        gc = get_gspread_client()
        if gc:
            try:
                sh = gc.open(SPREADSHEET_NAME)
                worksheet = sh.sheet1
                # ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ç¢ºèª
                if not worksheet.get_all_values():
                    worksheet.append_row(['ç”Ÿæˆæ—¥æ™‚', 'ãƒ†ãƒ¼ãƒ', 'æŠ•ç¨¿1', 'æŠ•ç¨¿2', 'æŠ•ç¨¿3', 'æŠ•ç¨¿4'])

                # ã‚¿ã‚¹ã‚¯ã«å¿œã˜ã¦é–¢æ•°ã‚’å®Ÿè¡Œ
                if task == "planner":
                    run_content_planner(worksheet)
                elif task == "affiliate":
                    run_affiliate_bot(worksheet, RAKUTEN_APP_ID, RAKUTEN_AFFILIATE_ID)

            except Exception as e:
                print(f"ğŸ›‘ ã‚¨ãƒ©ãƒ¼: ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼: {e}")
    else:
        print("ç¾åœ¨ã®æ™‚åˆ»ã¯ã€æŒ‡å®šã•ã‚ŒãŸæŠ•ç¨¿ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã‚ã‚Šã¾ã›ã‚“ã€‚")

    print("ğŸ å‡¦ç†ã‚’çµ‚äº†ã—ã¾ã™ã€‚")